let Joi,RFRESH_SECRET_KEY,RefreshModel,UserModel,CustomErrorHandler,JwtServices;_298‍.x([["default",()=>_298‍.o]]);_298‍.w("joi",[["default",["Joi"],function(v){Joi=v}]]);_298‍.w("../../config",[["RFRESH_SECRET_KEY",["RFRESH_SECRET_KEY"],function(v){RFRESH_SECRET_KEY=v}]]);_298‍.w("../../model",[["RefreshModel",["RefreshModel"],function(v){RefreshModel=v}],["UserModel",["UserModel"],function(v){UserModel=v}]]);_298‍.w("../../service/CustomErrorHandler",[["default",["CustomErrorHandler"],function(v){CustomErrorHandler=v}]]);_298‍.w("../../service/JwtServices",[["default",["JwtServices"],function(v){JwtServices=v}]]);





const refreshController = {
    async refreshToken(req, res, next) {
        // validation
        const refreshSchema = Joi.object({
            refresh_token: Joi.string().required()
        });

        const { error } = refreshSchema.validate(req.body);
        if (error) {
            return next(error)
        };

        // Check if is present refresh token in database then issued the new access token 
        let refreshToken;
        try {
            refreshToken = await RefreshModel.findOne({ token: req.body.refresh_token });
            if (!refreshToken) {
                return next(CustomErrorHandler.unAuthorized("Invaild refrsh token"))
            }
            // here refresh token is present then verify to the refresh token
            let userid;
            try {
                const { _id } = await JwtServices.verify(refreshToken.token, RFRESH_SECRET_KEY)
                userid = _id;
            } catch (error) {
                return next(CustomErrorHandler.unAuthorized("Invaild refrsh token"))
            }

            const user = await UserModel.findOne({ _id: userid });
            if (!user) {
                return next(CustomErrorHandler.unAuthorized("No user found"))
            }

            // Generate here new access and refresh token 
            const access_token = JwtServices.sign({ _id: user._id, role: user.role });
            const refresh_token = JwtServices.sign({ _id: user._id, role: user.role }, '1y', RFRESH_SECRET_KEY);

            //  database white list (means database me store karna)
            await RefreshModel.create({ token: refresh_token })

            res.json({ msg: "User hasbeen logged In", access_token, refresh_token })

        } catch (error) {
            return next(new Error("Someting went worng", err.message))
        }
        
    }
}

_298‍.d(refreshController);